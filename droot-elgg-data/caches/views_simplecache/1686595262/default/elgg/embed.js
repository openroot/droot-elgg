define("elgg/embed",function(require){var elgg=require('elgg');var $=require('jquery');var lightbox=require('elgg/lightbox');require('jquery.form');var embed={init:function(){embed.init=elgg.nullFunction;$(document).on('click',".embed-item",embed.insert);$(document).on('click',".embed-control",function(){var textAreaId=/embed-control-(\S)+/.exec($(this).attr('class'))[0];embed.textAreaId=textAreaId.substr("embed-control-".length);});$(document).on('click','.embed-wrapper .elgg-pagination a',embed.forward);$(document).on('click','.embed-section',embed.forward);$(document).on('submit','.elgg-form-embed',embed.submit);},insert:function(event){var textAreaId=embed.textAreaId;var textArea=$('#'+textAreaId);var content=' '+$(this).find(".embed-insert").parent().html()+' ';var value=textArea.val();var result=textArea.val();if(content.indexOf('/serve-icon/')!=-1){content=content.replace(/\/serve-icon\/[0-9]*\/small/g,function replacer(match){return match.replace('small','large');});}
textArea.focus();if(!elgg.isNullOrUndefined(textArea.prop('selectionStart'))){var cursorPos=textArea.prop('selectionStart');var textBefore=value.substring(0,cursorPos);var textAfter=value.substring(cursorPos,value.length);result=textBefore+content+textAfter;}else if(document.selection){var sel=document.selection.createRange();sel.text=content;result=textArea.val();}
result=elgg.trigger_hook('embed','editor',{textAreaId:textAreaId,content:content,value:value,event:event},result);if(result||result===''){textArea.val(result);}
lightbox.close();event.preventDefault();},submit:function(event){$('.embed-wrapper .elgg-form-file-upload').hide();$('.embed-throbber').show();$(this).ajaxSubmit({dataType:'json',data:{'X-Requested-With':'XMLHttpRequest'},success:function(response,status,xhr){if(response){if(response.system_messages){elgg.register_error(response.system_messages.error);elgg.system_message(response.system_messages.success);}
if(response.status>=0){var forward=$('input[name=embed_forward]').val();var url=elgg.normalize_url('embed/'+forward);url=embed.addContainerGUID(url);$('.embed-wrapper').parent().load(url);}else{$('.embed-throbber').hide();$('.embed-wrapper .elgg-form-file-upload').show();}}
else if(response===undefined&&$.browser.msie){var forward=$('input[name=embed_forward]').val();var url=elgg.normalize_url('embed/'+forward);url=embed.addContainerGUID(url);$('.embed-wrapper').parent().load(url);}},error:function(xhr,status){elgg.register_error(elgg.echo('actiongatekeeper:uploadexceeded'));$('.embed-throbber').hide();$('.embed-wrapper .elgg-form-file-upload').show();}});event.preventDefault();event.stopPropagation();},forward:function(event){var url=$(this).attr('href');url=embed.addContainerGUID(url);$('.embed-wrapper').parent().load(url,function(){$(window).trigger('resize.lightbox');});event.preventDefault();},addContainerGUID:function(url){if(url.indexOf('container_guid=')==-1){var guid=$('input[name=embed_container_guid]').val();return url+'?container_guid='+guid;}else{return url;}}};require(['elgg/init'],function(){embed.init();});return embed;});